<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ranking Xadrez Jovem ES</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7faff;
    --card:#fff;
    --text:#1a1f3b;
    --muted:#6b7280;
    --accent:#4f46e5;
    --accent-light:#818cf8;
    --gold:#f59e0b;
    --silver:#9ca3af;
    --bronze:#d97706;
    --border:#e5e7eb;
    --radius:14px;
    --shadow-card:0 8px 20px rgba(0,0,0,0.05);
    --shadow-hover:0 12px 24px rgba(0,0,0,0.08);
  }

  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);padding:20px;min-height:100vh;display:flex;justify-content:center;}
  .wrap{max-width:1100px;width:100%;display:flex;flex-direction:column;gap:24px;}

  /* Header */
  header.site{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
  .brand{display:flex;align-items:center;gap:16px;}
  .logo{width:60px;height:60px;background:linear-gradient(135deg,var(--accent),var(--accent-light));color:#fff;font-weight:800;font-size:24px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius);box-shadow:var(--shadow-card);}
  .brand h1{font-size:1.25rem;}
  .subtitle{font-size:0.9rem;color:var(--muted);}
  .top-meta .badge{background:#eef2ff;color:var(--accent);padding:8px 14px;border-radius:999px;font-weight:600;font-size:0.95rem;}

  /* Banner */
  .banner{display:flex;justify-content:space-between;align-items:center;background:var(--card);border-left:4px solid var(--accent);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow-card);}
  .banner a{color:var(--accent);font-weight:600;text-decoration:none;}
  .banner .btn{padding:10px 16px;background:linear-gradient(90deg,var(--accent),var(--accent-light));color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s;}
  .banner .btn:hover{opacity:0.9;transform:translateY(-1px);}
  .banner .ghost{background:transparent;border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer;transition:0.2s;}
  .banner .ghost:hover{background:#f3f4f6;}

  /* Controls */
  .controls{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;margin-bottom:12px;}
  .search{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.8);padding:8px 12px;border-radius:10px;border:1px solid var(--border);}
  .search input{border:none;background:transparent;outline:none;font-size:0.95rem;min-width:180px;}
  .select{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:0.95rem;}
  .info{color:var(--muted);font-size:0.9rem;align-self:center;}
  .btn, .ghost{transition:all 0.2s ease;}

  /* Table / Cards */
  .table-wrap{border-radius:var(--radius);}
  table{width:100%;border-collapse:collapse;min-width:720px;}
  thead th{position:sticky;top:0;background:var(--card);padding:14px;text-align:left;font-weight:600;font-size:0.95rem;color:var(--text);border-bottom:1px solid var(--border);}
  tbody td{padding:12px;border-bottom:1px solid var(--border);font-size:0.95rem;color:var(--text);}
  tbody tr:hover{background:rgba(79,70,229,0.05);}
  .rank{width:60px;font-weight:700;}
  .user a{color:var(--accent);font-weight:600;text-decoration:none;}
  .rating{text-align:right;font-weight:700;}
  .seen{text-align:right;color:var(--muted);}

  /* Medal colors top 3 */
  .medal-gold{color:var(--gold);}
  .medal-silver{color:var(--silver);}
  .medal-bronze{color:var(--bronze);}

  /* Pager */
  .pager{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end;}
  .pager button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;transition:all 0.2s;}
  .pager button:hover:not(:disabled){background:var(--accent-light);color:#fff;border:none;}
  .pager button:disabled{opacity:0.5;cursor:not-allowed;}

  /* Responsive Cards */
  @media(max-width:768px){
    table{display:none;}
    .card-list{display:flex;flex-direction:column;gap:16px;}
    .player-card{background:var(--card);border-radius:var(--radius);padding:16px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow-card);transition:all 0.2s;}
    .player-card:hover{box-shadow:var(--shadow-hover);}
    .player-info{display:flex;flex-direction:column;}
    .player-name{font-weight:600;color:var(--accent);font-size:1rem;}
    .player-metrics{display:flex;gap:12px;margin-top:6px;font-size:0.9rem;color:var(--text);}
    .player-metrics div{text-align:right;}
  }
</style>
</head>
<body>
<div class="wrap" id="app">
  <header class="site">
    <div class="brand">
      <div class="logo" aria-hidden="true">RJ</div>
      <div>
        <h1>Ranking Xadrez Jovem ES</h1>
        <div class="subtitle">Jogadores ativos — últimos 30 dias</div>
      </div>
    </div>
    <div class="top-meta">
      <div class="badge" aria-live="polite">Ativos: <strong id="totalBadge">—</strong></div>
    </div>
  </header>

  <div id="joinBanner" class="banner">
    <div>
      <strong>Quer aparecer no ranking?</strong>
      <div class="muted" style="margin-top:6px">
        Seja membro do time <strong>xadrezjovemes</strong> no Lichess.
        <div style="margin-top:8px"><a href="https://lichess.org/team/xadrezjovemes" target="_blank" rel="noopener">Entrar no time</a></div>
        <div style="margin-top:6px;font-size:0.9rem;color:var(--muted)">Aparece automaticamente após a geração diária.</div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
      <a class="btn" href="https://lichess.org/team/xadrezjovemes" target="_blank" rel="noopener">Entrar no time</a>
      <button id="dismissJoinBanner" class="ghost" aria-label="Fechar banner">Fechar</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <div class="search" title="Pesquisar usuário">
        <input id="q" type="search" placeholder="Buscar usuário..." aria-label="Buscar usuário">
        <button id="clearSearch" class="ghost" title="Limpar pesquisa" style="display:none">Limpar</button>
      </div>
      <select id="sort" class="select">
        <option value="blitz">Blitz</option>
        <option value="bullet">Bullet</option>
        <option value="rapid">Rapid</option>
        <option value="username">Usuário</option>
      </select>
      <select id="order" class="select">
        <option value="desc">Desc</option>
        <option value="asc">Asc</option>
      </select>
      <select id="perPage" class="select">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="reload" class="btn">Recarregar</button>
      <button id="exportCsv" class="ghost">Exportar CSV</button>
      <div id="info" class="info">—</div>
    </div>
  </div>

  <!-- Table (desktop) -->
  <div class="table-wrap" id="tableWrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Usuário</th>
          <th style="text-align:right">Blitz</th>
          <th style="text-align:right">Bullet</th>
          <th style="text-align:right">Rapid</th>
          <th style="text-align:right">Último login</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Card list (mobile) -->
  <div class="card-list" id="cardList"></div>

  <div class="pager" id="pager"></div>

  <footer style="text-align:center;font-size:0.9rem;color:var(--muted)">
    Dados: Lichess · Site atualizado uma vez por dia.
  </footer>
</div>

<script>
(() => {
  let all=[], filtered=[], page=1;
  const qEl=document.getElementById('q'), clearBtn=document.getElementById('clearSearch');
  const sortEl=document.getElementById('sort'), orderEl=document.getElementById('order'), perPageEl=document.getElementById('perPage');
  const infoEl=document.getElementById('info'), totalBadge=document.getElementById('totalBadge');
  const tbody=document.getElementById('tbody'), pager=document.getElementById('pager'), cardList=document.getElementById('cardList');
  const reloadBtn=document.getElementById('reload'), exportBtn=document.getElementById('exportCsv');

  function debounce(fn, wait=300){let t; return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait);};}
  function formatSeen(ms){if(!ms)return 'N/A'; const ts=Number(ms)||Date.parse(ms)||0; if(!ts)return 'N/A'; const diff=Date.now()-ts; if(diff<0)return 'Agora'; const days=Math.floor(diff/(24*3600*1000)); if(days===0)return 'Hoje'; if(days===1)return '1 dia'; if(days<30)return `${days} dias`; const months=Math.floor(days/30); if(months<12)return `${months} meses`; return `${Math.floor(months/12)} anos`; }
  function safeNumber(v){ return v==null||v===''?0:Number(v)||0; }

  async function loadData(force=false){
    infoEl.textContent='Carregando...';
    try{
      const res=await fetch('./players.json',{cache:force?'no-store':'default'});
      if(!res.ok)throw new Error('Falha ao buscar players.json');
      const js=await res.json();
      all=Array.isArray(js.players)?js.players:[];
      totalBadge.textContent=all.length;
      infoEl.textContent=`Total: ${all.length} — gerado: ${js.generated_at?new Date(js.generated_at).toLocaleString():'—'}`;
      page=1;
      applyFilters();
    }catch(err){console.error(err);infoEl.textContent='Erro ao carregar dados';tbody.innerHTML='<tr><td colspan="6" style="padding:18px;text-align:center;color:#6b7280">Erro ao carregar players.json</td></tr>';}
  }

  function applyFilters(){
    const q=qEl.value.trim().toLowerCase();
    filtered=all.filter(p=>{if(!q)return true; return (p.username||'').toLowerCase().includes(q);});
    const key=sortEl.value, order=orderEl.value==='asc'?1:-1;
    filtered.sort((a,b)=>{
      if(key==='username'){const A=(a.username||'').toLowerCase(),B=(b.username||'').toLowerCase();return (A<B?-1:A>B?1:0)*order;}
      const va=safeNumber(a[key]),vb=safeNumber(b[key]);return (va<vb?-1:va>vb?1:0)*order;
    });
    page=1; renderPage(); clearBtn.style.display=q?'inline-block':'none';
  }

  function renderPage(){
    const per=Math.max(1,parseInt(perPageEl.value,10)||20), totalPages=Math.max(1,Math.ceil(filtered.length/per));
    if(page>totalPages)page=totalPages;
    const start=(page-1)*per, items=filtered.slice(start,start+per);

    // Desktop table
    const frag=document.createDocumentFragment();
    if(items.length===0){const tr=document.createElement('tr');tr.innerHTML='<td colspan="6" style="padding:18px;text-align:center;color:#6b7280">Nenhum jogador encontrado</td>'; frag.appendChild(tr);}
    else{
      items.forEach((p,idx)=>{
        const tr=document.createElement('tr'); const rank=start+idx+1;
        tr.innerHTML=`<td class="rank ${rank===1?'medal-gold':rank===2?'medal-silver':rank===3?'medal-bronze':''}">${rank}</td>
        <td class="user"><a href="${p.profile||'#'}" target="_blank" rel="noopener">${p.username||'(sem usuário)'}</a></td>
        <td class="rating">${p.blitz??'—'}</td>
        <td class="rating">${p.bullet??'—'}</td>
        <td class="rating">${p.rapid??'—'}</td>
        <td class="seen">${formatSeen(p.seenAt)}</td>`;
        frag.appendChild(tr);
      });
    }
    tbody.innerHTML=''; tbody.appendChild(frag);

    // Mobile cards
    cardList.innerHTML='';
    items.forEach((p,idx)=>{
      const rank=start+idx+1;
      const div=document.createElement('div'); div.className='player-card';
      div.innerHTML=`<div class="player-info">
        <div class="player-name">${rank}. ${p.username||'(sem usuário)'}</div>
        <div class="player-metrics">
          <div>Blitz: ${p.blitz??'—'}</div>
          <div>Bullet: ${p.bullet??'—'}</div>
          <div>Rapid: ${p.rapid??'—'}</div>
        </div>
      </div>
      <div class="seen">${formatSeen(p.seenAt)}</div>`;
      cardList.appendChild(div);
    });

    // Pager
    renderPager(per,totalPages);
  }

  function renderPager(per,totalPages){
    pager.innerHTML='';
    const make=(label,p,disabled=false)=>{const b=document.createElement('button');b.textContent=label;b.disabled=disabled;b.onclick=()=>{page=p;renderPage();window.scrollTo({top:0,behavior:'smooth'});};return b;};
    pager.appendChild(make('«',1,page===1));
    pager.appendChild(make('‹',Math.max(1,page-1),page===1));
    const start=Math.max(1,page-2),end=Math.min(totalPages,page+2);
    for(let i=start;i<=end;i++){
      const b=make(String(i),i,i===page); if(i===page){b.style.fontWeight='700';b.style.background='linear-gradient(90deg,var(--accent),var(--accent-light))';b.style.color='#fff';b.style.border='none';} pager.appendChild(b);
    }
    pager.appendChild(make('›',Math.min(totalPages,page+1),page===totalPages));
    pager.appendChild(make('»',totalPages,page===totalPages));
  }

  function exportCurrentPageCsv(){
    const per=Math.max(1,parseInt(perPageEl.value,10)||20),start=(page-1)*per,items=filtered.slice(start,start+per);
    if(items.length===0){alert('Nenhum item para exportar');return;}
    const headers=['#','username','profile','blitz','bullet','rapid','seenAt'];
    const rows=items.map((p,idx)=>[start+idx+1,p.username,p.profile,p.blitz,p.bullet,p.rapid,p.seenAt]);
    const csv=[headers.join(','),...rows.map(r=>r.map(v=>`"${v??''}"`).join(','))].join('\r\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`ranking_page${page}.csv`; a.click();
  }

  const debouncedFilter=debounce(applyFilters,300);

  qEl.addEventListener('input',debouncedFilter);
  clearBtn.addEventListener('click',()=>{qEl.value='';applyFilters();});
  sortEl.addEventListener('change',applyFilters);
  orderEl.addEventListener('change',applyFilters);
  perPageEl.addEventListener('change',renderPage);
  reloadBtn.addEventListener('click',()=>loadData(true));
  exportBtn.addEventListener('click',exportCurrentPageCsv);

  document.getElementById('dismissJoinBanner').addEventListener('click',()=>{document.getElementById('joinBanner').style.display='none';});

  loadData();
})();
</script>
</body>
</html>
