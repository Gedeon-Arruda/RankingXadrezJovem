<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="expires" content="0">
<meta http-equiv="pragma" content="no-cache">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ranking Xadrez Jovem ES</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* ----------------- Variáveis e reset ----------------- */
  :root{
    --bg:#f4f6fb;
    --card:#ffffff;
    --muted:#667085;
    --accent:#3b82f6;
    --accent-2:#7c3aed;
    --text:#0b1220;
    --border:rgba(15,23,36,0.06);
    --radius:14px;
    --shadow-lg: 0 20px 50px rgba(16,24,40,0.08);
    --shadow-sm: 0 6px 18px rgba(16,24,40,0.06);
    --green:#10b981;
    --red:#ef4444;
    --violet:#6366f1;
    --gray:#9ca3af;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%);color:var(--text);padding:28px;min-height:100vh;display:flex;justify-content:center}
  .container{max-width:1150px;width:100%;display:flex;flex-direction:column;gap:18px}

  /* ----------------- Header / hero / controls ----------------- */
  header.site{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px;box-shadow:var(--shadow-lg);flex-shrink:0}
  .title-group h1{font-size:1.15rem;margin-bottom:2px}
  .subtitle{color:var(--muted);font-size:0.9rem}

  .meta{display:flex;gap:10px;align-items:center}
  .badge{background:linear-gradient(90deg,rgba(59,130,246,0.06),transparent);color:var(--accent);padding:8px 12px;border-radius:999px;font-weight:700;font-size:.9rem;border:1px solid rgba(59,130,246,0.08);box-shadow:var(--shadow-sm);min-width:92px;text-align:center}

  .hero{background:linear-gradient(180deg,rgba(255,255,255,0.7),var(--card));border-radius:var(--radius);padding:14px;border:1px solid var(--border);box-shadow:var(--shadow-sm);display:flex;justify-content:space-between;align-items:center;gap:14px}
  .hero .left{max-width:70%}
  .hero p{color:var(--muted);margin-top:6px;font-size:0.95rem}
  .hero .cta{display:flex;gap:10px;align-items:center}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:700;box-shadow:0 10px 30px rgba(59,130,246,0.12);text-decoration:none}
  .btn-ghost{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer}

  .controls{display:flex;justify-content:space-between;gap:12px;align-items:center}
  .controls-left{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .search{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#fff,rgba(255,255,255,0.95));padding:8px 12px;border-radius:12px;border:1px solid var(--border);min-width:260px;box-shadow:var(--shadow-sm);flex:0 1 320px}
  .search input{border:0;outline:0;background:transparent;font-size:0.95rem;color:var(--text);width:100%}
  .select{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:0.95rem}

  .controls-right{display:flex;align-items:center;gap:10px}

  /* ----------------- Table / cards ----------------- */
  .card{background:var(--card);border-radius:18px;padding:12px;border:1px solid var(--border);box-shadow:var(--shadow-lg)}
  .table-wrap{overflow:auto;width:100%;border-radius:12px}
  table{width:100%;border-collapse:collapse;min-width:720px}
  thead th{background:transparent;text-align:left;padding:14px;font-weight:700;color:var(--muted);font-size:0.95rem;white-space:nowrap}
  tbody td{padding:12px;border-top:1px solid var(--border);vertical-align:middle}
  tbody tr{transition:background .18s, transform .12s}
  tbody tr:hover{background:linear-gradient(90deg,rgba(124,58,237,0.03),transparent);transform:translateY(-2px)}

  .rank{width:64px;font-weight:800;color:var(--accent);font-size:0.95rem}
  .pos-col{width:72px;text-align:center;font-weight:800}
  .user a{color:var(--accent);font-weight:700;text-decoration:none}
  .user .realname{display:block;color:var(--muted);font-size:0.86rem;margin-top:4px;font-weight:600}
  .rating{text-align:right;font-weight:800}
  .seen{text-align:right;color:var(--muted);font-weight:600}

  .diff{font-size:0.82rem;margin-left:8px;padding:4px 8px;border-radius:999px;font-weight:700;white-space:nowrap}
  .diff-pos{background:rgba(16,185,129,0.12);color:var(--green);border:1px solid rgba(16,185,129,0.16)}
  .diff-neg{background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.12)}
  .diff-zero{background:rgba(99,102,241,0.06);color:var(--violet);border:1px solid rgba(99,102,241,0.08)}

  .pos-arrow {font-weight:900;margin-right:6px}
  .pos-up{color:var(--green)}
  .pos-down{color:var(--red)}
  .pos-same{color:var(--gray)}

  .card-list{display:none}
  @media(max-width:880px){
    header.site{flex-direction:column;align-items:flex-start;gap:10px}
    .title-group h1{font-size:1.05rem}
    .meta{width:100%;display:flex;justify-content:space-between}

    .hero{flex-direction:column;align-items:flex-start}
    .hero .left{max-width:100%}

    .controls{flex-direction:column;align-items:stretch}
    .controls-left{width:100%;align-items:center}
    .search{flex:1;min-width:unset;width:100%}
    .select{flex:0 0 auto}
    .controls-right{width:100%;justify-content:space-between}

    table{display:none}
    .card-list{display:flex;flex-direction:column;gap:12px}
    .player-card{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow-sm)}
    .player-left{display:flex;gap:12px;align-items:center;min-width:0}
    .avatar{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;flex-shrink:0}
    .player-names{display:flex;flex-direction:column;min-width:0}
    .player-nick{font-weight:800;color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .player-real{color:var(--muted);font-size:0.92rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .player-right{text-align:right;color:var(--muted);font-weight:700;display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:110px}
    .player-right .diff{display:inline-block;margin-top:6px}

    .pager{justify-content:center;flex-wrap:wrap;gap:8px}
    .pager button{min-width:44px;padding:8px 10px}
    .card{padding:10px}
  }

  @media(max-width:480px){
    body{padding:18px}
    .logo{width:52px;height:52px;font-size:18px}
    .avatar{width:48px;height:48px}
    .player-right{min-width:90px}
    .badge{padding:6px 10px;font-size:0.85rem}
    .btn-primary{padding:8px 12px;font-size:0.9rem}
    .search{padding:6px 10px}
    .select{padding:6px 8px}
    .hero p{font-size:0.9rem}
    .player-card{flex-direction:column;align-items:flex-start}
    .player-right{align-items:flex-start;text-align:left}
    .player-nick{font-size:0.98rem}
  }

  .pager{display:flex;gap:8px;justify-content:flex-end;padding-top:10px}
  .pager button{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer}

  footer{color:var(--muted);text-align:center;margin-top:6px;font-size:0.9rem}
  .legend{display:flex;gap:12px;align-items:center;margin-top:8px;color:var(--muted);font-size:0.9rem;flex-wrap:wrap}
  .legend .item{display:flex;align-items:center;gap:8px}
  .legend .sw{width:14px;height:14px;border-radius:6px}

  .truncate{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  a.button-like{text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<div class="container" id="app">
  <!-- Header com título e badge de total -->
  <header class="site">
    <div class="brand">
      <a class="logo" href="./" aria-label="Ir para a página inicial">XJES</a>
      <div class="title-group">
        <h1>Ranking Xadrez Jovem ES</h1>
        <div class="subtitle">Jogadores ativos — últimos 30 dias</div>
      </div>
    </div>

    <div class="meta">
      <!-- Badge que será preenchida dinamicamente com a quantidade de ativos -->
      <div class="badge" aria-live="polite">Ativos: <strong id="totalBadge">—</strong></div>
    </div>
  </header>

  <!-- Hero / Call to action -->
  <div class="hero">
    <div class="left">
      <strong>Quer aparecer no ranking?</strong>
      <p>Seja membro do time <strong>xadrezjovemes</strong> no Lichess. Aparece automaticamente após a geração diária.</p>
    </div>
    <div class="cta">
      <a class="btn-primary" href="https://lichess.org/team/xadrezjovemes" target="_blank" rel="noopener">Entrar no time</a>
      <button id="dismissJoinBanner" class="btn-ghost">Fechar</button>
    </div>
  </div>

  <!-- Controles: busca, ordenação, paginação -->
  <div class="controls">
    <div class="controls-left">
      <div class="search" title="Pesquisar usuário">
        <input id="q" type="search" placeholder="Buscar usuário..." aria-label="Buscar usuário">
      </div>
      <select id="sort" class="select" title="Ordenar">
        <option value="blitz">Blitz</option>
        <option value="bullet">Bullet</option>
        <option value="rapid">Rapid</option>
        <option value="position">Posição</option>
        <option value="username">Usuário</option>
      </select>
      <select id="order" class="select" title="Ordem">
        <option value="desc">Desc</option>
        <option value="asc">Asc</option>
      </select>
      <select id="perPage" class="select" title="Por página">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
      </select>
    </div>

    <div class="controls-right">
      <button id="exportCsv" class="btn-ghost">Exportar CSV</button>
      <div id="info" class="subtitle">—</div>
    </div>
  </div>

  <!-- Card com tabela / lista responsiva -->
  <div class="card">
    <div class="table-wrap" aria-hidden="false">
      <table aria-live="polite">
        <thead>
          <tr>
            <th>#</th>
            <th class="pos-col">Δ</th>
            <th>Usuário</th>
            <th style="text-align:right">Blitz</th>
            <th style="text-align:right">Bullet</th>
            <th style="text-align:right">Rapid</th>
            <th style="text-align:right">Último login</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card-list" id="cardList" aria-hidden="true"></div>

    <div class="legend" aria-hidden="true">
      <div class="item"><span class="sw" style="background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.16)"></span>Subiu</div>
      <div class="item"><span class="sw" style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.12)"></span>Caiu</div>
      <div class="item"><span class="sw" style="background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.08)"></span>Manteve</div>
    </div>

    <div class="pager" id="pager"></div>
  </div>

  <footer>Dados: Lichess · Site atualizado uma vez por dia.</footer>
</div>

<script>
/*
  Script principal do frontend.
  - Faz fetch de ./players.json (espera o mesmo formato do backend)
  - Dedupe/ordena/exibe em tabela (desktop) e cards (mobile)
  - Exporta CSV, pesquisa, paginação e ordenação
  Observações:
   - Mantive código legível e com comentários em português.
   - Não há qualquer lógica de contador/visit (removido a pedido).
*/

(() => {
  // estado
  let all = [], filtered = [], page = 1;

  // elementos DOM
  const qEl = document.getElementById('q');
  const sortEl = document.getElementById('sort'), orderEl = document.getElementById('order'), perPageEl = document.getElementById('perPage');
  const infoEl = document.getElementById('info'), totalBadge = document.getElementById('totalBadge');
  const tbody = document.getElementById('tbody'), pager = document.getElementById('pager'), cardList = document.getElementById('cardList');
  const exportBtn = document.getElementById('exportCsv');

  /* ---------- helpers ---------- */

  // debounce simples
  function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

  // formata timestamp (ms) para string amigável
  function formatSeen(ms){
    if(!ms) return '—';
    const ts = Number(ms) || Date.parse(ms) || 0; if(!ts) return '—';
    const diff = Date.now() - ts; if(diff < 0) return 'Agora';
    const days = Math.floor(diff/(24*3600*1000));
    if(days === 0) return 'Hoje';
    if(days === 1) return '1 dia';
    if(days < 30) return `${days} dias`;
    const months = Math.floor(days/30);
    if(months < 12) return `${months} meses`;
    return `${Math.floor(months/12)} anos`;
  }

  // converte valores para número seguro
  function safeNumber(v){ return v==null||v===''?0:Number(v)||0; }

  // format diff como "(+n)" / "(-n)" / "(0)"
  function formatDiff(d){
    const n = (d === null || d === undefined || d === '') ? 0 : Number(d);
    if(Number.isNaN(n)) return '(0)';
    const sign = n > 0 ? '+' : '';
    return `(${sign}${n})`;
  }

  // badge de posição com seta
  function posBadge(p){
    if(!p || p.position_arrow == null) return '';
    const arrow = p.position_arrow;
    const change = (typeof p.position_change === 'number') ? Math.abs(p.position_change) : '';
    const cls = arrow === '▲' ? 'pos-up' : (arrow === '▼' ? 'pos-down' : 'pos-same');
    return `<div style="display:flex;align-items:center;justify-content:center"><span class="pos-arrow ${cls}">${escapeHtml(arrow)}</span>${change ? `<span style="font-weight:700">${change}</span>` : ''}</div>`;
  }

  // extrai arrays do JSON e normaliza input possível
  function extractPlayers(obj){
    const found = [];
    if(!obj) return found;
    if(Array.isArray(obj)) return obj.slice();
    if(Array.isArray(obj.players)) found.push(...obj.players);
    Object.values(obj).forEach(v=>{
      if(Array.isArray(v)) found.push(...v);
    });
    return found;
  }

  // dedupe por username (mantém o melhor por soma de ratings ou último seen)
  function dedupePlayers(list){
    const map = new Map();
    const score = p => safeNumber(p.blitz) + safeNumber(p.bullet) + safeNumber(p.rapid);
    list.forEach(p=>{
      const key = (p.username||'').toString().trim().toLowerCase();
      if(!key){
        const id = `__anon_${Math.random().toString(36).slice(2,9)}`;
        map.set(id, Object.assign({},p,{username:id}));
        return;
      }
      if(!map.has(key)) map.set(key, p);
      else {
        const existing = map.get(key);
        if(score(p) > score(existing)) map.set(key,p);
        else {
          const eSeen = Date.parse(existing.seenAt||'')||0;
          const pSeen = Date.parse(p.seenAt||'')||0;
          if(pSeen > eSeen) map.set(key,p);
        }
      }
    });
    return Array.from(map.values());
  }

  /* ---------- carregamento e render ---------- */

  // carrega players.json e inicializa UI
  async function loadData(force=false){
    infoEl.textContent = 'Carregando...';
    try{
      const url = './players.json?v=' + Date.now();
      const res = await fetch(url, {cache: 'no-store'});
      if(!res.ok) throw new Error('Falha ao buscar players.json: ' + res.status);
      const js = await res.json();

      let candidates = extractPlayers(js);
      if(candidates.length === 0 && Array.isArray(js.players)) candidates = js.players.slice();
      all = dedupePlayers(candidates);

      // ordenação padrão: por position se existir, senão por blitz
      if(all.length && all[0].position != null){
        all.sort((a,b)=> (safeNumber(a.position) - safeNumber(b.position)));
      }else{
        all.sort((a,b)=> (safeNumber(b.blitz) - safeNumber(a.blitz)));
      }

      totalBadge.textContent = all.length;
      const gen = js.generated_at ? new Date(Number(js.generated_at)).toLocaleString() : '—';
      infoEl.textContent = `Total: ${all.length} — gerado: ${gen}`;
      page = 1;
      applyFilters();
    }catch(err){
      console.error(err);
      infoEl.textContent = 'Erro ao carregar dados';
      tbody.innerHTML = '<tr><td colspan="7" style="padding:18px;text-align:center;color:#6b7280">Erro ao carregar players.json</td></tr>';
    }
  }

  // aplica busca/ordenação e mostra primeira página
  function applyFilters(){
    const q = (qEl.value || '').trim().toLowerCase();
    filtered = all.filter(p => {
      if(!q) return true;
      return (p.username||'').toString().toLowerCase().includes(q) || (p.name||p.realname||'').toString().toLowerCase().includes(q);
    });

    const key = sortEl.value, ord = orderEl.value === 'asc' ? 1 : -1;
    filtered.sort((a,b)=>{
      if(key === 'username'){ const A=(a.username||'').toLowerCase(), B=(b.username||'').toLowerCase(); return (A < B ? -1 : A > B ? 1 : 0) * ord; }
      if(key === 'position'){
        const pa = a.position == null ? Infinity : Number(a.position);
        const pb = b.position == null ? Infinity : Number(b.position);
        return (pa < pb ? -1 : pa > pb ? 1 : 0) * ord;
      }
      const va = safeNumber(a[key]), vb = safeNumber(b[key]);
      return (va < vb ? -1 : va > vb ? 1 : 0) * ord;
    });
    page = 1;
    renderPage();
  }

  // renderiza página atual (tabela desktop + cards mobile)
  function renderPage(){
    const per = Math.max(1, parseInt(perPageEl.value,10) || 20);
    const totalPages = Math.max(1, Math.ceil(filtered.length / per));
    if(page > totalPages) page = totalPages;
    const start = (page - 1) * per;
    const items = filtered.slice(start, start + per);

    // tabela desktop
    if(items.length === 0){
      tbody.innerHTML = '<tr><td colspan="7" style="padding:18px;text-align:center;color:#6b7280">Nenhum jogador encontrado</td></tr>';
    } else {
      const rows = items.map((p,idx)=>{
        const rank = start + idx + 1;
        const real = p.name || p.realname || p.fullname || '';
        const profile = (p.profile || p.url) ? (p.profile || p.url) : `https://lichess.org/@/${encodeURIComponent(p.username||'')}`;
        const userEsc = escapeHtml(p.username||'(sem usuário)');
        const realHtml = real ? `<span class="realname">${escapeHtml(real)}</span>` : `<span class="realname">Sem nome registrado</span>`;
        return `<tr>
          <td class="rank">${rank}</td>
          <td class="pos-col">${posBadge(p)}</td>
          <td class="user"><a href="${profile}" target="_blank" rel="noopener">${userEsc}</a>${realHtml}</td>
          <td class="rating">${p.blitz ?? '—'} <span class="${(p.blitz_diff>0)?'diff diff-pos':(p.blitz_diff<0)?'diff diff-neg':'diff diff-zero'}">${formatDiff(p.blitz_diff)}</span></td>
          <td class="rating">${p.bullet ?? '—'} <span class="${(p.bullet_diff>0)?'diff diff-pos':(p.bullet_diff<0)?'diff diff-neg':'diff diff-zero'}">${formatDiff(p.bullet_diff)}</span></td>
          <td class="rating">${p.rapid ?? '—'} <span class="${(p.rapid_diff>0)?'diff diff-pos':(p.rapid_diff<0)?'diff diff-neg':'diff diff-zero'}">${formatDiff(p.rapid_diff)}</span></td>
          <td class="seen">${formatSeen(p.seenAt)}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    }

    // lista mobile (cards)
    cardList.innerHTML = '';
    items.forEach((p, idx) => {
      const rank = start + idx + 1;
      const real = p.name || p.realname || p.fullname || 'Sem nome registrado';
      const profile = (p.profile || p.url) ? (p.profile || p.url) : `https://lichess.org/@/${encodeURIComponent(p.username||'')}`;
      const initial = escapeHtml((p.username||'').charAt(0).toUpperCase());
      const userEsc = escapeHtml(p.username||'(sem usuário)');
      const realEsc = real ? escapeHtml(real) : '';
      const posHtml = p.position_arrow ? `<span class="pos-arrow ${p.position_arrow==='▲'?'pos-up':p.position_arrow==='▼'?'pos-down':'pos-same'}">${p.position_arrow}</span>` : '';
      const html = `<div class="player-card" role="group" aria-label="Jogador ${userEsc}">
        <div class="player-left">
          <a href="${profile}" target="_blank" rel="noopener" style="display:flex;gap:12px;align-items:center;text-decoration:none;color:inherit;width:100%">
            <div class="avatar" aria-hidden="true">${initial}</div>
            <div class="player-names">
              <div class="player-nick truncate">${rank}. ${userEsc}</div>
              <div class="player-real truncate">${realEsc}</div>
            </div>
          </a>
        </div>
        <div class="player-right">
          <div style="font-weight:700">Pos: ${p.position ?? rank} ${posHtml} ${p.position_change != null ? Math.abs(p.position_change) : ''}</div>
          <div style="font-size:0.95rem">Blitz: ${p.blitz ?? '—'} <span class="${(p.blitz_diff>0)?'diff diff-pos':(p.blitz_diff<0)?'diff diff-neg':'diff diff-zero'}">${formatDiff(p.blitz_diff)}</span></div>
          <div style="font-size:0.95rem">Bullet: ${p.bullet ?? '—'} <span class="${(p.bullet_diff>0)?'diff diff-pos':(p.bullet_diff<0)?'diff diff-neg':'diff diff-zero'}">${formatDiff(p.bullet_diff)}</span></div>
          <div style="font-size:0.95rem">Rapid: ${p.rapid ?? '—'} <span class="${(p.rapid_diff>0)?'diff diff-pos':(p.rapid_diff<0)?'diff diff-neg':'diff diff-zero'}">${formatDiff(p.rapid_diff)}</span></div>
          <div style="font-size:0.85rem;color:var(--muted);margin-top:6px">${formatSeen(p.seenAt)}</div>
        </div>
      </div>`;
      cardList.insertAdjacentHTML('beforeend', html);
    });

    renderPager(per, totalPages);

    // acessibilidade: alterna aria-hidden entre tabela e lista conforme viewport
    const isMobile = window.matchMedia('(max-width:880px)').matches;
    document.querySelector('.table-wrap').setAttribute('aria-hidden', String(isMobile));
    document.getElementById('cardList').setAttribute('aria-hidden', String(!isMobile));
  }

  // render pager simples
  function renderPager(per, totalPages){
    pager.innerHTML = '';
    const make = (label, to, disabled=false) => {
      const b = document.createElement('button'); b.textContent = label; b.disabled = disabled;
      b.onclick = () => { page = to; renderPage(); window.scrollTo({top:0,behavior:'smooth'}); };
      return b;
    };
    pager.appendChild(make('«',1,page===1));
    pager.appendChild(make('‹', Math.max(1,page-1), page===1));
    const start = Math.max(1, page-2), end = Math.min(totalPages, page+2);
    for(let i=start;i<=end;i++){
      const btn = make(String(i), i, i===page);
      if(i===page){ btn.style.fontWeight='700'; btn.style.background = 'linear-gradient(90deg,var(--accent),var(--accent-2))'; btn.style.color='#fff'; btn.style.border='none'; }
      pager.appendChild(btn);
    }
    pager.appendChild(make('›', Math.min(totalPages, page+1), page===totalPages));
    pager.appendChild(make('»', totalPages, page===totalPages));
  }

  /* ---------- utilitários ---------- */

  // exporta página atual para CSV (download)
  function exportCurrentPageCsv(){
    const per = Math.max(1, parseInt(perPageEl.value,10)||20), start = (page-1)*per;
    const items = filtered.slice(start, start+per);
    if(!items.length){ alert('Nenhum item para exportar'); return; }
    const headers = ['#','username','name','profile','position','position_change','position_arrow','blitz','blitz_diff','bullet','bullet_diff','rapid','rapid_diff','seenAt'];
    const rows = items.map((p,idx)=>[
      start+idx+1,
      p.username||'',
      p.name||p.realname||'',
      p.profile||'',
      p.position ?? '',
      (p.position_change != null ? p.position_change : ''),
      p.position_arrow || '',
      p.blitz || '',
      p.blitz_diff != null ? p.blitz_diff : 0,
      p.bullet || '',
      p.bullet_diff != null ? p.bullet_diff : 0,
      p.rapid || '',
      p.rapid_diff != null ? p.rapid_diff : 0,
      p.seenAt || ''
    ]);
    const csv = [headers.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\r\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = `ranking_page${page}.csv`; a.click();
  }

  // escape simples para HTML
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

  /* ---------- listeners e inicialização ---------- */

  const debouncedFilter = debounce(applyFilters, 250);
  qEl.addEventListener('input', debouncedFilter);
  sortEl.addEventListener('change', applyFilters);
  orderEl.addEventListener('change', applyFilters);
  perPageEl.addEventListener('change', renderPage);
  exportBtn.addEventListener('click', exportCurrentPageCsv);
  document.getElementById('dismissJoinBanner').addEventListener('click', ()=>document.querySelector('.hero').style.display='none');

  // carrega dados ao iniciar
  loadData();

  // re-render quando viewport muda (troca tabela/cards)
  const mql = window.matchMedia('(max-width:880px)');
  if (mql.addEventListener) mql.addEventListener('change', ()=>{ renderPage(); });
  else if (mql.addListener) mql.addListener(()=>{ renderPage(); }); // fallback antigo

})();
</script>
</body>
</html>
