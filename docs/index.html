<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ranking Xadrez Jovem ES</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#eef5ff;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0b63ff;
      --accent-2:#004ecb;
      --table-border:#e6e9ee;
      --glass: rgba(255,255,255,0.75);
      --radius:12px;
      --shadow-1: 0 6px 18px rgba(6,34,102,0.06);
      --shadow-2: 0 10px 30px rgba(6,34,102,0.08);
      --glass-2: rgba(255,255,255,0.85);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(180deg,var(--bg),#f7fbff);
      color:#07102a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:24px;
      -webkit-tap-highlight-color: transparent;
    }

    /* Container */
    .wrap{max-width:1160px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    header.site{display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap}

    /* Brand */
    .brand{display:flex;gap:14px;align-items:center}
    .logo{
      width:64px;height:64px;border-radius:14px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:22px;
      box-shadow:var(--shadow-2);
      flex:0 0 auto;
    }
    .brand h1{font-size:1.125rem;margin:0}
    .subtitle{color:var(--muted);font-size:0.92rem;margin-top:3px}

    .top-meta{display:flex;gap:12px;align-items:center}
    .badge{
      background:linear-gradient(180deg,#f1f9ff,#eef6ff);
      color:var(--accent);padding:8px 12px;border-radius:999px;border:1px solid rgba(11,102,255,0.08);
      font-weight:700;font-size:0.95rem;display:flex;gap:8px;align-items:center;
    }

    /* Card */
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow-1)}
    .banner{display:flex;gap:12px;align-items:center;border-left:4px solid var(--accent);padding:14px}

    /* Controls */
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .controls .left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search{display:flex;align-items:center;gap:8px;background:var(--glass);padding:8px;border-radius:10px;border:1px solid rgba(11,20,40,0.04)}
    .search svg{opacity:.7}
    .search input{
      border:0;background:transparent;outline:none;padding:6px 8px;font-size:0.95rem;min-width:160px;
    }

    .select, .btn, .ghost{
      padding:8px 10px;border-radius:10px;border:1px solid var(--table-border);background:#fff;font-size:0.95rem;
    }
    .btn{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;border:none;cursor:pointer;box-shadow:0 6px 20px rgba(11,99,255,0.08)}
    .ghost{background:transparent;border:1px solid rgba(16,24,40,0.05);color:var(--muted)}
    .btn:focus, .select:focus, .search input:focus, .ghost:focus{outline:3px solid rgba(11,99,255,0.12);outline-offset:2px}

    .info{color:var(--muted);font-size:0.9rem;margin-left:6px}

    /* Table */
    .table-wrap{overflow:auto;border-radius:10px;border:1px solid var(--table-border);background:linear-gradient(180deg,#fff,#fbfdff);margin-top:8px}
    table{width:100%;border-collapse:collapse;min-width:720px;table-layout:auto}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#ffffff,#f7fbff);padding:14px;text-align:left;border-bottom:1px solid var(--table-border);font-weight:700;font-size:0.95rem;color:#07102a}
    tbody td{padding:12px;border-bottom:1px solid var(--table-border);vertical-align:middle;font-size:0.95rem;color:#122036}
    tbody tr:hover{background:linear-gradient(90deg,rgba(11,99,255,0.03),transparent)}
    .rank{width:72px;font-weight:700;color:var(--accent);text-align:left}
    .user a{color:var(--accent);text-decoration:none;font-weight:600;word-break:break-word}
    .small{display:block;color:var(--muted);font-size:0.86rem;margin-top:6px}
    .rating{font-weight:700;color:#0b1220;text-align:right;min-width:72px}
    .seen{color:var(--muted);font-size:0.92rem;text-align:right;min-width:120px}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    .pager{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px;justify-content:flex-end}
    .pager button{background:#fff;border:1px solid #eef3fb;padding:8px 10px;border-radius:10px;cursor:pointer}
    .pager button[disabled]{opacity:.5;cursor:default}

    /* Responsive / Mobile cards */
    @media (max-width:900px){
      .search input{min-width:120px}
      thead th, tbody td{padding:10px}
      .logo{width:56px;height:56px}
      .brand h1{font-size:1rem}
    }

    @media (max-width:720px){
      body{padding:14px}
      .wrap{padding:0}
      .logo{width:48px;height:48px;font-size:18px}
      .search input{min-width:96px}
      table{min-width:0}
      thead{display:none}
      tbody tr{
        display:block;border-radius:10px;padding:12px;margin:10px 0;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 6px 18px rgba(6,34,102,0.04);border:1px solid var(--table-border)
      }
      tbody td{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border:0;font-size:0.95rem}
      tbody td.user{flex-direction:column;align-items:flex-start;gap:6px}
      tbody td.user a{font-size:1rem}
      .metric-row{display:flex;gap:10px;width:100%;margin-top:6px}
      .metric{flex:1;display:flex;flex-direction:column;align-items:flex-end;min-width:64px}
      .metric .label{color:var(--muted);font-size:0.82rem}
      .metric .value{font-weight:700}
      .rank{display:inline-block;margin-bottom:6px}
      .pager{justify-content:center}
      .actions{width:100%;justify-content:flex-end}
    }

    @media (max-width:420px){
      .search input{min-width:72px}
      .brand h1{font-size:0.98rem}
    }

    /* small utilities */
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--glass-2);border:1px solid rgba(11,20,40,0.03)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header class="site">
      <div class="brand">
        <div class="logo" aria-hidden="true">RJ</div>
        <div>
          <h1>Ranking Xadrez Jovem ES</h1>
          <div class="subtitle">Jogadores ativos — últimos 30 dias</div>
        </div>
      </div>
      <div class="top-meta">
        <div class="badge" aria-live="polite">Ativos: <strong id="totalBadge">—</strong></div>
      </div>
    </header>

    <!-- Banner -->
    <div id="joinBanner" class="card banner" role="region" aria-label="Informação para aparecer no ranking">
      <div style="flex:1">
        <strong>Quer aparecer no ranking?</strong>
        <div class="muted" style="margin-top:6px">
          Seja membro do time <strong>xadrezjovemes</strong> no Lichess e tenha rating Blitz.
          <div style="margin-top:8px"><a href="https://lichess.org/team/xadrezjovemes" target="_blank" rel="noopener">Entrar no time</a></div>
          <div style="margin-top:6px;font-size:0.9rem;color:var(--muted)">Aparece automaticamente após a geração diária.</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <a class="btn" href="https://lichess.org/team/xadrezjovemes" target="_blank" rel="noopener" style="padding:10px 14px">Entrar no time</a>
        <button id="dismissJoinBanner" class="ghost" aria-label="Fechar banner">Fechar</button>
      </div>
    </div>

    <!-- Main card -->
    <div class="card" role="main" aria-labelledby="main-title">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div class="search" title="Pesquisar usuário">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#456" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#456" stroke-width="2"/></svg>
            <input id="q" type="search" placeholder="Buscar usuário..." aria-label="Buscar usuário" />
            <button id="clearSearch" class="ghost" title="Limpar pesquisa" aria-label="Limpar pesquisa" style="display:none">Limpar</button>
          </div>

          <label class="sr-only" for="sort">Ordenar por</label>
          <select id="sort" class="select" aria-label="Ordenar por">
            <option value="blitz">Blitz</option>
            <option value="bullet">Bullet</option>
            <option value="rapid">Rapid</option>
            <option value="username">Usuário</option>
          </select>

          <label class="sr-only" for="order">Ordem</label>
          <select id="order" class="select" aria-label="Ordem">
            <option value="desc">Desc</option>
            <option value="asc">Asc</option>
          </select>

          <label class="sr-only" for="perPage">Por página</label>
          <select id="perPage" class="select" aria-label="Itens por página">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <button id="reload" class="btn" title="Recarregar dados">Recarregar</button>
          <button id="exportCsv" class="ghost" title="Exportar página para CSV">Exportar CSV</button>
          <div id="info" class="info" aria-live="polite">—</div>
        </div>
      </div>

      <div class="table-wrap" id="tableWrap" role="region" aria-label="Tabela de jogadores">
        <table aria-describedby="table-desc">
          <caption id="table-desc" class="sr-only">Lista de jogadores com rating Blitz, Bullet e Rapid</caption>
          <thead>
            <tr>
              <th class="rank" scope="col">#</th>
              <th scope="col">Usuário</th>
              <th scope="col" style="text-align:right">Blitz</th>
              <th scope="col" style="text-align:right">Bullet</th>
              <th scope="col" style="text-align:right">Rapid</th>
              <th scope="col" style="text-align:right">Último login</th>
            </tr>
          </thead>
          <tbody id="tbody" role="rowgroup"></tbody>
        </table>
      </div>

      <div class="pager" id="pager" aria-label="Navegação de páginas"></div>
    </div>

    <footer style="margin-top:6px;color:var(--muted);font-size:0.9rem;text-align:center">
      Dados: Lichess · Site atualizado uma vez por dia.
    </footer>
  </div>

<script>
/* Responsive, accessible, premium table UI
   - Assumes players.json structure: { "generated_at": <ms-or-iso>, "players": [ { username, profile, blitz, bullet, rapid, seenAt } ] }
   - Features: debounce search, CSV export, accessible pagination, mobile card layout handled by CSS
*/

(() => {
  // State
  let all = [];
  let filtered = [];
  let page = 1;

  const qEl = document.getElementById('q');
  const clearBtn = document.getElementById('clearSearch');
  const sortEl = document.getElementById('sort');
  const orderEl = document.getElementById('order');
  const perPageEl = document.getElementById('perPage');
  const infoEl = document.getElementById('info');
  const totalBadge = document.getElementById('totalBadge');
  const tbody = document.getElementById('tbody');
  const pager = document.getElementById('pager');
  const reloadBtn = document.getElementById('reload');
  const exportBtn = document.getElementById('exportCsv');

  // Helpers
  function debounce(fn, wait=300){
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
  }

  function escapeHtml(s){
    return String(s==null?'':s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function formatSeen(ms){
    if(!ms) return 'N/A';
    const ts = Number(ms) || Date.parse(ms) || 0;
    if(!ts) return 'N/A';
    const diff = Date.now() - ts;
    if(diff < 0) return 'Agora';
    const days = Math.floor(diff / (24*3600*1000));
    if(days === 0) return 'Hoje';
    if(days === 1) return '1 dia';
    if(days < 30) return `${days} dias`;
    const months = Math.floor(days / 30);
    if(months < 12) return `${months} meses`;
    const years = Math.floor(months / 12);
    return `${years} anos`;
  }

  function safeNumber(v){ return v == null || v === '' ? 0 : Number(v) || 0; }

  async function loadData(force=false){
    infoEl.textContent = 'Carregando...';
    try{
      const res = await fetch('./players.json', { cache: force ? 'no-store' : 'default' });
      if(!res.ok) throw new Error('Falha ao buscar players.json');
      const js = await res.json();
      all = Array.isArray(js.players) ? js.players : [];
      totalBadge.textContent = all.length;
      const dt = js.generated_at ? new Date(js.generated_at).toLocaleString() : '—';
      infoEl.textContent = `Total: ${all.length} — gerado: ${dt}`;
      page = 1;
      applyFilters();
    }catch(err){
      console.error(err);
      infoEl.textContent = 'Erro ao carregar dados';
      tbody.innerHTML = `<tr><td colspan="6" style="padding:18px;text-align:center;color:var(--muted)">Erro ao carregar players.json</td></tr>`;
    }
  }

  function applyFilters(){
    const q = qEl.value.trim().toLowerCase();
    filtered = all.filter(p => {
      if(!q) return true;
      const uname = (p.username || '').toString().toLowerCase();
      return uname.includes(q);
    });

    // sort
    const key = sortEl.value;
    const order = orderEl.value === 'asc' ? 1 : -1;
    filtered.sort((a,b) => {
      if(key === 'username'){
        const A = (a.username||'').toLowerCase();
        const B = (b.username||'').toLowerCase();
        return (A < B ? -1 : A > B ? 1 : 0) * order;
      }
      const va = safeNumber(a[key]);
      const vb = safeNumber(b[key]);
      return (va < vb ? -1 : va > vb ? 1 : 0) * order;
    });

    page = 1;
    renderPage();
    clearBtn.style.display = q ? 'inline-block' : 'none';
  }

  function renderPage(){
    const per = Math.max(1, parseInt(perPageEl.value,10) || 20);
    const totalPages = Math.max(1, Math.ceil(filtered.length / per));
    if(page > totalPages) page = totalPages;

    const start = (page - 1) * per;
    const items = filtered.slice(start, start + per);

    // build fragment for performance
    const frag = document.createDocumentFragment();
    if(items.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" style="padding:18px;text-align:center;color:var(--muted)">Nenhum jogador encontrado</td>`;
      frag.appendChild(tr);
    } else {
      items.forEach((p, idx) => {
        const tr = document.createElement('tr');
        const rank = start + idx + 1;

        // desktop cells (semantic) — CSS will transform into cards on mobile
        const tdRank = document.createElement('td'); tdRank.className = 'rank'; tdRank.setAttribute('data-label','#'); tdRank.innerHTML = `${rank}`;
        const tdUser = document.createElement('td'); tdUser.className = 'user'; tdUser.setAttribute('data-label','Usuário');
        const a = document.createElement('a'); a.href = p.profile || '#'; a.target = '_blank'; a.rel = 'noopener'; a.textContent = p.username || '(sem usuário)';
        tdUser.appendChild(a);
        const small = document.createElement('span'); small.className='small'; small.textContent = p.username || ''; tdUser.appendChild(small);

        const tdBlitz = document.createElement('td'); tdBlitz.className='rating'; tdBlitz.setAttribute('data-label','Blitz'); tdBlitz.style.textAlign='right'; tdBlitz.textContent = p.blitz ?? '—';
        const tdBullet = document.createElement('td'); tdBullet.className='rating'; tdBullet.setAttribute('data-label','Bullet'); tdBullet.style.textAlign='right'; tdBullet.textContent = p.bullet ?? '—';
        const tdRapid = document.createElement('td'); tdRapid.className='rating'; tdRapid.setAttribute('data-label','Rapid'); tdRapid.style.textAlign='right'; tdRapid.textContent = p.rapid ?? '—';
        const tdSeen = document.createElement('td'); tdSeen.className='seen'; tdSeen.setAttribute('data-label','Último login'); tdSeen.style.textAlign='right'; tdSeen.textContent = formatSeen(p.seenAt);

        tr.appendChild(tdRank);
        tr.appendChild(tdUser);
        tr.appendChild(tdBlitz);
        tr.appendChild(tdBullet);
        tr.appendChild(tdRapid);
        tr.appendChild(tdSeen);

        frag.appendChild(tr);
      });
    }

    tbody.innerHTML = '';
    tbody.appendChild(frag);
    renderPager(per, totalPages);
  }

  function renderPager(per, totalPages){
    pager.innerHTML = '';
    const make = (label, p, disabled=false, ariaLabel) => {
      const b = document.createElement('button');
      b.textContent = label;
      b.disabled = disabled;
      b.setAttribute('aria-label', ariaLabel || `Ir para página ${p}`);
      b.className = 'select';
      b.onclick = () => { page = p; renderPage(); window.scrollTo({top:0,behavior:'smooth'}); };
      return b;
    };
    const first = make('«', 1, page===1, 'Primeira página');
    const prev = make('‹', Math.max(1,page-1), page===1, 'Página anterior');
    pager.appendChild(first);
    pager.appendChild(prev);

    const start = Math.max(1, page - 2);
    const end = Math.min(totalPages, page + 2);
    for(let i=start;i<=end;i++){
      const b = make(String(i), i, i===page, `Página ${i}`);
      if(i===page){ b.style.fontWeight='700'; b.style.background='linear-gradient(90deg,var(--accent),var(--accent-2))'; b.style.color='#fff'; b.style.border='none' }
      pager.appendChild(b);
    }

    const next = make('›', Math.min(totalPages, page+1), page===totalPages, 'Próxima página');
    const last = make('»', totalPages, page===totalPages, 'Última página');
    pager.appendChild(next);
    pager.appendChild(last);
  }

  // CSV export for the current page
  function exportCurrentPageCsv(){
    const per = Math.max(1, parseInt(perPageEl.value,10) || 20);
    const start = (page - 1) * per;
    const items = filtered.slice(start, start + per);
    if(items.length === 0){ alert('Nenhum item para exportar'); return; }
    const headers = ['#','username','profile','blitz','bullet','rapid','seenAt'];
    const rows = items.map((p,idx) => {
      const rank = start + idx + 1;
      return [rank, p.username || '', p.profile || '', p.blitz ?? '', p.bullet ?? '', p.rapid ?? '', p.seenAt ?? ''].map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',');
    });
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `ranking_page_${page}.csv`; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
  }

  // Bind events (with debounce)
  const debouncedFilter = debounce(applyFilters, 220);
  qEl.addEventListener('input', debouncedFilter);
  clearBtn.addEventListener('click', ()=>{ qEl.value=''; applyFilters(); qEl.focus(); });
  sortEl.addEventListener('change', ()=>{ page = 1; applyFilters(); });
  orderEl.addEventListener('change', ()=>{ page = 1; applyFilters(); });
  perPageEl.addEventListener('change', ()=>{ page = 1; renderPage(); });
  reloadBtn.addEventListener('click', ()=> loadData(true));
  exportBtn.addEventListener('click', exportCurrentPageCsv);

  // Join banner dismiss (persistent)
  (function joinBanner(){
    const key = 'rk_join_banner_dismissed_v1';
    const banner = document.getElementById('joinBanner');
    const btn = document.getElementById('dismissJoinBanner');
    if(!banner || !btn) return;
    try{
      if(localStorage.getItem(key)){ banner.style.display='none'; return; }
    }catch(e){}
    btn.addEventListener('click', ()=>{
      banner.style.display = 'none';
      try{ localStorage.setItem(key,'1'); }catch(e){}
    });
  })();

  // initial load
  window.addEventListener('load', ()=> loadData(false));
})();
</script>
</body>
</html>
